name: ğŸš€ EAS Production Build & Submit

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - ios
          - android
      submit:
        description: 'Auto-submit to stores'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

jobs:
  prepare:
    name: ğŸ“‹ Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_notes: ${{ steps.notes.outputs.notes }}
      should_submit: ${{ steps.check.outputs.submit }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(cat mobile/package.json | jq -r '.version')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: Get release notes
        id: notes
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            # Get release notes from GitHub Release
            NOTES=$(gh release view "v${{ steps.version.outputs.version }}" --json body -q '.body' 2>/dev/null || echo "Bug fixes and improvements")
            # Truncate for store requirements (500 chars)
            NOTES=$(echo "$NOTES" | head -c 450)
          else
            NOTES="Bug fixes and improvements"
          fi
          # Escape for JSON
          NOTES=$(echo "$NOTES" | jq -Rs .)
          echo "notes=$NOTES" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if should submit
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            echo "submit=true" >> $GITHUB_OUTPUT
          else
            echo "submit=${{ github.event.inputs.submit }}" >> $GITHUB_OUTPUT
          fi

  build-ios:
    name: ğŸ Build iOS
    needs: prepare
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'ios' ||
      github.event.inputs.platform == 'all'
    defaults:
      run:
        working-directory: ./mobile

    outputs:
      build_id: ${{ steps.build.outputs.build_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build iOS
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform ios --profile production --non-interactive --json)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[0].id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ğŸ iOS Build ID: $BUILD_ID"

      - name: Setup App Store Connect API Key
        if: needs.prepare.outputs.should_submit == 'true'
        run: |
          echo "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | base64 -d > AuthKey_W3TGVKY5Z6.p8
          echo "âœ… App Store Connect API Key configured"

      - name: Submit to App Store
        if: needs.prepare.outputs.should_submit == 'true'
        run: |
          echo "ğŸ“¤ Submitting iOS to App Store..."
          eas submit --platform ios --profile production --non-interactive --latest

      - name: Cleanup iOS credentials
        if: always()
        run: rm -f AuthKey_W3TGVKY5Z6.p8

  build-android:
    name: ğŸ¤– Build Android
    needs: prepare
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      github.event.inputs.platform == 'android' ||
      github.event.inputs.platform == 'all'
    defaults:
      run:
        working-directory: ./mobile

    outputs:
      build_id: ${{ steps.build.outputs.build_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm ci

      - name: Build Android
        id: build
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive --json)
          BUILD_ID=$(echo "$BUILD_OUTPUT" | jq -r '.[0].id')
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "ğŸ¤– Android Build ID: $BUILD_ID"

      - name: Setup Google Play Service Account
        if: needs.prepare.outputs.should_submit == 'true'
        run: |
          echo '${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}' > android-service-account.json
          echo "âœ… Google Play Service Account configured"

      - name: Submit to Google Play
        if: needs.prepare.outputs.should_submit == 'true'
        run: |
          echo "ğŸ“¤ Submitting Android to Google Play..."
          eas submit --platform android --profile production --non-interactive --latest

      - name: Cleanup Android credentials
        if: always()
        run: rm -f android-service-account.json

  summary:
    name: ğŸ“Š Build Summary
    needs: [prepare, build-ios, build-android]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ğŸš€ Production Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v${{ needs.prepare.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-Submit:** ${{ needs.prepare.outputs.should_submit }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status | Build ID |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ iOS | ${{ needs.build-ios.result }} | ${{ needs.build-ios.outputs.build_id || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ¤– Android | ${{ needs.build-android.result }} | ${{ needs.build-android.outputs.build_id || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Links" >> $GITHUB_STEP_SUMMARY
          echo "- [EAS Builds](https://expo.dev/accounts/leszekszpunar/projects/slow-spot/builds)" >> $GITHUB_STEP_SUMMARY
          echo "- [App Store Connect](https://appstoreconnect.apple.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Google Play Console](https://play.google.com/console)" >> $GITHUB_STEP_SUMMARY

  notify-release:
    name: ğŸ“¢ Create GitHub Release
    needs: [prepare, build-ios, build-android]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Update Release with Build Info
        uses: actions/github-script@v7
        with:
          script: |
            const tag = context.ref.replace('refs/tags/', '');
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: tag
            });

            const buildInfo = `

            ---

            ## ğŸ“± Build Status

            | Platform | Status |
            |----------|--------|
            | ğŸ iOS | ${{ needs.build-ios.result }} |
            | ğŸ¤– Android | ${{ needs.build-android.result }} |

            **Auto-submitted to stores:** ${{ needs.prepare.outputs.should_submit }}

            [View builds on Expo](https://expo.dev/accounts/leszekszpunar/projects/slow-spot/builds)
            `;

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.data.id,
              body: release.data.body + buildInfo
            });
