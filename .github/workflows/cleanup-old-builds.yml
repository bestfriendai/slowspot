name: Cleanup Old Builds

on:
  # Run automatically after each successful build
  workflow_run:
    workflows: ["EAS Preview Build (Test Deployment)", "EAS Production Build", "EAS Update (OTA - Expo Go)"]
    types:
      - completed

  # Run weekly to clean up old builds
  schedule:
    - cron: '0 0 * * 0' # Every Sunday at midnight

  # Manual trigger
  workflow_dispatch:
    inputs:
      keep_count:
        description: 'Number of recent workflow runs to keep'
        required: true
        default: '5'
        type: string

jobs:
  cleanup:
    name: Cleanup Old Workflow Runs
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ github.token }}
          REPO: ${{ github.repository }}
          KEEP_COUNT: ${{ github.event.inputs.keep_count || '5' }}
        run: |
          echo "üßπ Cleaning up old workflow runs..."
          echo "üìä Keeping the ${KEEP_COUNT} most recent runs for each workflow"

          # Get all workflows
          workflows=$(gh api repos/${REPO}/actions/workflows --jq '.workflows[] | .id')

          for workflow_id in $workflows; do
            workflow_name=$(gh api repos/${REPO}/actions/workflows/${workflow_id} --jq '.name')
            echo ""
            echo "üìã Processing workflow: ${workflow_name}"

            # Get all runs for this workflow, sorted by creation date (newest first)
            run_ids=$(gh api \
              "repos/${REPO}/actions/workflows/${workflow_id}/runs" \
              --paginate \
              --jq '.workflow_runs | sort_by(.created_at) | reverse | .[].id')

            # Count total runs
            total=$(echo "$run_ids" | wc -l | xargs)
            echo "   Total runs: ${total}"

            # Skip the first KEEP_COUNT runs (most recent)
            to_delete=$(echo "$run_ids" | tail -n +$((KEEP_COUNT + 1)))
            delete_count=$(echo "$to_delete" | grep -c . || echo 0)

            if [ "$delete_count" -gt 0 ]; then
              echo "   üóëÔ∏è  Deleting ${delete_count} old runs..."

              # Delete each old run
              echo "$to_delete" | while read -r run_id; do
                if [ -n "$run_id" ]; then
                  gh api \
                    --method DELETE \
                    "repos/${REPO}/actions/runs/${run_id}" \
                    2>/dev/null && echo "      ‚úÖ Deleted run ${run_id}" || echo "      ‚ùå Failed to delete run ${run_id}"
                fi
              done
            else
              echo "   ‚ú® No runs to delete (${total} runs, keeping ${KEEP_COUNT})"
            fi
          done

          echo ""
          echo "‚úÖ Cleanup complete!"

  cleanup-artifacts:
    name: Cleanup Old Artifacts
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Delete old artifacts
        uses: c-hive/gha-remove-artifacts@v1
        with:
          age: '7 days'
          skip-recent: 5
          GITHUB_TOKEN: ${{ github.token }}

  cleanup-cache:
    name: Cleanup Old Cache
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old cache entries
        run: |
          echo "Cleaning up old cache entries..."
          # GitHub automatically removes cache entries older than 7 days
          # or when total cache size exceeds 10GB
          # This step serves as documentation
          echo "‚úÖ Cache cleanup is handled automatically by GitHub"
          echo "   - Removes entries older than 7 days"
          echo "   - Maintains max 10GB total cache size"
